<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои задачи | Система управления складом</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1'
            },
            status: {
              planned: '#6B7280',
              inProgress: '#3B82F6',
              completed: '#10B981',
              cancelled: '#EF4444',
            },
            priority: {
              critical: '#DC2626',
              high: '#F97316',
              medium: '#F59E0B',
              low: '#10B981',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50" x-data="taskManager()">

<header class="bg-white border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold text-gray-900">Мои задачи</h1>
        <span class="ml-3 px-2.5 py-0.5 rounded-full bg-primary-100 text-primary-700 text-sm font-medium" th:text="${activeTasksCount + ' активных'}">5 активных</span>
      </div>

      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-500" th:text="${#temporals.format(#temporals.createNow(), 'dd.MM.yyyy')}">01.01.2024</div>
        <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                              th:classappend="${
                                  userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN ? 'bg-purple-100 text-purple-800' :
                                  userRole == T(bbt.tao.warehouse.model.enums.RoleType).MANAGER ? 'bg-blue-100 text-blue-800' :
                                  'bg-green-100 text-green-800'
                              }"
                              th:text="${userRole}">
                            ADMIN
                        </span>
        </div>
      </div>
    </div>

    <!-- Счетчики задач -->
    <div class="py-3 flex space-x-6 overflow-x-auto">
      <div class="flex flex-col items-center">
        <span class="text-lg font-semibold" th:text="${taskCounts.planned}">4</span>
        <span class="text-xs text-gray-500">Запланировано</span>
      </div>
      <div class="flex flex-col items-center">
        <span class="text-lg font-semibold" th:text="${taskCounts.inProgress}">6</span>
        <span class="text-xs text-gray-500">В процессе</span>
      </div>
      <div class="flex flex-col items-center">
        <span class="text-lg font-semibold" th:text="${taskCounts.completed}">10</span>
        <span class="text-xs text-gray-500">Выполнено</span>
      </div>
      <div class="flex flex-col items-center">
        <span class="text-lg font-semibold text-red-500" th:text="${taskCounts.overdue}">2</span>
        <span class="text-xs text-gray-500">Просрочено</span>
      </div>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Панель создания задачи (только для ADMIN и MANAGER) -->
  <div th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN || userRole == T(bbt.tao.warehouse.model.enums.RoleType).MANAGER}"
       class="mb-6">
    <button
            @click="showTaskCreationForm = true"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
      <i class="fas fa-plus mr-2"></i>
      Создать задачу
    </button>
  </div>

  <!-- Форма создания задачи (показывается при нажатии на кнопку) -->
  <div x-show="showTaskCreationForm"
       class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
       x-transition>
    <div @click.away="showTaskCreationForm = false"
         class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-lg font-medium">Создание задачи</h2>
        <button @click="showTaskCreationForm = false" class="text-gray-400 hover:text-gray-500">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form class="p-6 space-y-6">
        <!-- Основная информация -->
        <div class="space-y-4">
          <div>
            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Название задачи *</label>
            <input type="text" id="taskTitle" name="title" required
                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
          </div>

          <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700">Описание</label>
            <textarea id="taskDescription" name="description" rows="3"
                      class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
          </div>
        </div>

        <!-- Назначение и планирование -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="assignee" class="block text-sm font-medium text-gray-700">Исполнитель *</label>
            <select id="assignee" name="assigneeId" required
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
              <option value="" selected disabled>Выберите исполнителя</option>
              <option th:each="user : ${availableAssignees}" th:value="${user.id}" th:text="${user.fullName}"></option>
            </select>
          </div>

          <div>
            <label for="priority" class="block text-sm font-medium text-gray-700">Приоритет</label>
            <select id="priority" name="priority"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
              <option value="LOW">Низкий</option>
              <option value="MEDIUM" selected>Средний</option>
              <option value="HIGH">Высокий</option>
              <option value="CRITICAL">Критический</option>
            </select>
          </div>

          <div>
            <label for="dueDate" class="block text-sm font-medium text-gray-700">Срок выполнения *</label>
            <input type="datetime-local" id="dueDate" name="dueDate" required
                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
          </div>

          <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Категория</label>
            <select id="category" name="categoryId"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
              <option value="" selected disabled>Выберите категорию</option>
              <option th:each="category : ${taskCategories}" th:value="${category.id}" th:text="${category.name}"></option>
            </select>
          </div>
        </div>

        <!-- Детали местоположения -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="location" class="block text-sm font-medium text-gray-700">Местоположение</label>
            <select id="location" name="locationId"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
              <option value="" selected disabled>Выберите местоположение</option>
              <option th:each="location : ${warehouseLocations}" th:value="${location.id}" th:text="${location.name}"></option>
            </select>
          </div>
        </div>

        <!-- Связанные элементы -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Связанные товары</label>
          <div class="mt-1 flex rounded-md shadow-sm">
            <select multiple id="relatedItems" name="relatedItemIds"
                    class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
              <option th:each="item : ${inventoryItems}" th:value="${item.id}" th:text="${item.sku + ' - ' + item.name}"></option>
            </select>
          </div>
          <p class="mt-1 text-sm text-gray-500">Зажмите Ctrl для множественного выбора</p>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" @click="showTaskCreationForm = false"
                  class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            Отмена
          </button>
          <button type="submit"
                  class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            Создать задачу
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Фильтры и поиск -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="p-4">
      <div class="flex flex-col md:flex-row md:items-center space-y-3 md:space-y-0 md:space-x-4">
        <div class="flex-grow">
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="search" name="search" id="search"
                   class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md"
                   placeholder="Поиск по задачам...">
          </div>
        </div>
        <div class="flex space-x-2">
          <button @click="showFilters = !showFilters"
                  class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-filter mr-2"></i>
            Фильтры
          </button>

          <div class="relative" x-data="{ open: false }">
            <button @click="open = !open"
                    class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
              <i class="fas fa-sort mr-2"></i>
              Сортировка
            </button>

            <div x-show="open"
                 @click.away="open = false"
                 class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10"
                 x-transition>
              <div class="py-1">
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">По сроку (по возрастанию)</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">По сроку (по убыванию)</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">По приоритету</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">По дате создания</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">По статусу</a>
              </div>
            </div>
          </div>

          <div class="flex border border-gray-300 rounded-md">
            <button @click="viewMode = 'list'"
                    :class="{'bg-gray-100': viewMode === 'list'}"
                    class="px-3 py-2 text-gray-600 hover:text-gray-900 focus:outline-none">
              <i class="fas fa-list"></i>
            </button>
            <button @click="viewMode = 'grid'"
                    :class="{'bg-gray-100': viewMode === 'grid'}"
                    class="px-3 py-2 text-gray-600 hover:text-gray-900 focus:outline-none">
              <i class="fas fa-th-large"></i>
            </button>
            <button @click="viewMode = 'calendar'"
                    :class="{'bg-gray-100': viewMode === 'calendar'}"
                    class="px-3 py-2 text-gray-600 hover:text-gray-900 focus:outline-none">
              <i class="fas fa-calendar-alt"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Развернутые фильтры -->
      <div x-show="showFilters" class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4" x-transition>
        <div>
          <label class="block text-sm font-medium text-gray-700">Статус</label>
          <select class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            <option value="">Все</option>
            <option th:each="status : ${T(bbt.tao.warehouse.model.enums.InventoryStatus).values()}"
                    th:value="${status}"
                    th:text="${status}"></option>
            <option value="OVERDUE">Просрочено</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Приоритет</label>
          <select class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            <option value="">Все</option>
            <option value="LOW">Низкий</option>
            <option value="MEDIUM">Средний</option>
            <option value="HIGH">Высокий</option>
            <option value="CRITICAL">Критический</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Категория</label>
          <select class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            <option value="">Все</option>
            <option th:each="category : ${taskCategories}" th:value="${category.id}" th:text="${category.name}"></option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Дата</label>
          <select class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            <option value="">Любая дата</option>
            <option value="today">Сегодня</option>
            <option value="week">На этой неделе</option>
            <option value="month">В этом месяце</option>
            <option value="custom">Указать период...</option>
          </select>
        </div>

        <!-- Фильтр по исполнителю (только для ADMIN) -->
        <div th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN}">
          <label class="block text-sm font-medium text-gray-700">Исполнитель</label>
          <select class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            <option value="">Все</option>
            <option th:each="user : ${availableAssignees}" th:value="${user.id}" th:text="${user.fullName}"></option>
          </select>
        </div>

        <div class="md:col-span-4 flex justify-end">
          <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            Применить фильтры
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Секция с задачами -->
  <div>
    <!-- Список задач -->
    <div x-show="viewMode === 'list'" class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 bg-white shadow rounded-lg">
        <thead>
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <input type="checkbox" class="rounded text-primary-600">
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Приоритет</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Название</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Категория</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Срок</th>
          <th scope="col" th:if="${userRole != T(bbt.tao.warehouse.model.enums.RoleType).WAREHOUSE_WORKER}"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Исполнитель</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Прогресс</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-gray-200" th:remove="all-but-first">
        <tr th:each="task : ${tasks}">
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" class="rounded text-primary-600">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span th:if="${task.priority == 'CRITICAL'}" class="flex-shrink-0 inline-block h-2 w-2 rounded-full bg-priority-critical"></span>
            <span th:if="${task.priority == 'HIGH'}" class="flex-shrink-0 inline-block h-2 w-2 rounded-full bg-priority-high"></span>
            <span th:if="${task.priority == 'MEDIUM'}" class="flex-shrink-0 inline-block h-2 w-2 rounded-full bg-priority-medium"></span>
            <span th:if="${task.priority == 'LOW'}" class="flex-shrink-0 inline-block h-2 w-2 rounded-full bg-priority-low"></span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${task.id}">TK-123</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900" th:text="${task.title}">Инвентаризация склада А</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      th:classappend="${
                                          task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).PLANNED ? 'bg-gray-100 text-gray-800' :
                                          task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).IN_PROGRESS ? 'bg-blue-100 text-blue-800' :
                                          task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).COMPLETED ? 'bg-green-100 text-green-800' :
                                          'bg-red-100 text-red-800'
                                      }"
                                      th:text="${task.status}">
                                    PLANNED
                                </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${task.category?.name}">Инвентаризация</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500" th:text="${#temporals.format(task.dueDate, 'dd.MM.yyyy HH:mm')}">31.12.2024 18:00</div>
            <div class="text-xs text-red-500" th:if="${task.isOverdue}">Просрочено</div>
          </td>
          <td th:if="${userRole != T(bbt.tao.warehouse.model.enums.RoleType).WAREHOUSE_WORKER}" class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="text-xs font-medium" th:text="${#strings.substring(task.assignee.fullName, 0, 2)}">МР</span>
              </div>
              <div class="ml-2 text-sm text-gray-900" th:text="${task.assignee.fullName}">Михаил Родригес</div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-primary-500 h-2 rounded-full" th:style="'width: ' + ${task.progressPercentage} + '%'"></div>
            </div>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex space-x-2 justify-end">
              <button @click="openTaskDetails(task)" class="text-primary-600 hover:text-primary-900"
                      title="Просмотр деталей">
                <i class="fas fa-eye"></i>
              </button>

              <button th:if="${task.status != T(bbt.tao.warehouse.model.enums.InventoryStatus).COMPLETED &&
                task.status != T(bbt.tao.warehouse.model.enums.InventoryStatus).CANCELLED}"
                      class="text-blue-600 hover:text-blue-900" title="Начать выполнение">
                <i class="fas fa-play"></i>
              </button>

              <button th:if="${task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).IN_PROGRESS}"
                      class="text-green-600 hover:text-green-900" title="Завершить задачу">
                <i class="fas fa-check"></i>
              </button>

              <button th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN ||
                userRole == T(bbt.tao.warehouse.model.enums.RoleType).MANAGER}"
                      class="text-indigo-600 hover:text-indigo-900" title="Редактировать">
                <i class="fas fa-edit"></i>
              </button>

              <button th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN}"
                      class="text-red-600 hover:text-red-900" title="Удалить">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Представление задач в виде сетки (карточки) -->
    <div x-show="viewMode === 'grid'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div th:each="task : ${tasks}" class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
          <!-- Заголовок и индикатор приоритета -->
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg leading-6 font-medium text-gray-900" th:text="${task.title}">Инвентаризация склада А</h3>
              <p class="text-sm text-gray-500 mt-1" th:text="${task.category?.name}">Инвентаризация</p>
            </div>
            <span th:if="${task.priority == 'CRITICAL'}" class="flex-shrink-0 inline-block h-3 w-3 rounded-full bg-priority-critical"></span>
            <span th:if="${task.priority == 'HIGH'}" class="flex-shrink-0 inline-block h-3 w-3 rounded-full bg-priority-high"></span>
            <span th:if="${task.priority == 'MEDIUM'}" class="flex-shrink-0 inline-block h-3 w-3 rounded-full bg-priority-medium"></span>
            <span th:if="${task.priority == 'LOW'}" class="flex-shrink-0 inline-block h-3 w-3 rounded-full bg-priority-low"></span>
          </div>

          <!-- Статус задачи -->
          <div class="mt-4 flex items-center justify-between">
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
            th:classappend="${
                task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).PLANNED ? 'bg-gray-100 text-gray-800' :
                task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).IN_PROGRESS ? 'bg-blue-100 text-blue-800' :
                task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).COMPLETED ? 'bg-green-100 text-green-800' :
                'bg-red-100 text-red-800'
            }"
            th:text="${task.status}">
          PLANNED
      </span>
            <div class="text-sm text-gray-500" th:text="${#temporals.format(task.dueDate, 'dd.MM.yyyy HH:mm')}">31.12.2024 18:00</div>
          </div>

          <!-- Описание задачи (если есть) -->
          <p th:if="${task.description}" class="mt-3 text-sm text-gray-600 line-clamp-3" th:text="${task.description}">
            Провести полную инвентаризацию склада А, включая проверку соответствия фактического наличия товаров данным в системе.
          </p>

          <!-- Исполнитель -->
          <div th:if="${userRole != T(bbt.tao.warehouse.model.enums.RoleType).WAREHOUSE_WORKER}" class="mt-4 flex items-center">
            <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
              <span class="text-xs font-medium" th:text="${#strings.substring(task.assignee.fullName, 0, 2)}">МР</span>
            </div>
            <div class="ml-2 text-sm text-gray-900" th:text="${task.assignee.fullName}">Михаил Родригес</div>
          </div>

          <!-- Прогресс-бар -->
          <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-primary-500 h-2 rounded-full" th:style="'width: ' + ${task.progressPercentage} + '%'"></div>
            </div>
          </div>

          <!-- Действия -->
          <div class="mt-5 flex space-x-3 justify-end">
            <button @click="openTaskDetails(task)" class="text-primary-600 hover:text-primary-900"
                    title="Просмотр деталей">
              <i class="fas fa-eye"></i>
            </button>

            <button th:if="${task.status != T(bbt.tao.warehouse.model.enums.InventoryStatus).COMPLETED &&
                  task.status != T(bbt.tao.warehouse.model.enums.InventoryStatus).CANCELLED}"
                    class="text-blue-600 hover:text-blue-900" title="Начать выполнение">
              <i class="fas fa-play"></i>
            </button>

            <button th:if="${task.status == T(bbt.tao.warehouse.model.enums.InventoryStatus).IN_PROGRESS}"
                    class="text-green-600 hover:text-green-900" title="Завершить задачу">
              <i class="fas fa-check"></i>
            </button>

            <button th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN ||
                  userRole == T(bbt.tao.warehouse.model.enums.RoleType).MANAGER}"
                    class="text-indigo-600 hover:text-indigo-900" title="Редактировать">
              <i class="fas fa-edit"></i>
            </button>

            <button th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN}"
                    class="text-red-600 hover:text-red-900" title="Удалить">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Представление задач в виде календаря -->
    <div x-show="viewMode === 'calendar'" class="bg-white shadow rounded-lg overflow-hidden">
      <div class="p-4">
        <div class="flex justify-between items-center mb-4">
          <div class="flex space-x-2">
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">
              Сегодня
            </button>
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <h3 class="text-lg font-medium">Ноябрь 2024</h3>
          <div class="flex space-x-2">
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 active:bg-gray-100">Месяц</button>
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">Неделя</button>
            <button class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">День</button>
          </div>
        </div>

        <!-- Дни недели -->
        <div class="grid grid-cols-7 gap-px bg-gray-200">
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Пн</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Вт</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Ср</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Чт</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Пт</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Сб</div>
          <div class="bg-white p-2 text-center text-xs font-medium text-gray-500">Вс</div>
        </div>

        <!-- Сетка календаря -->
        <div class="grid grid-cols-7 gap-px bg-gray-200 border-t border-gray-200">
          <!-- Дни предыдущего месяца -->
          <div class="bg-gray-50 min-h-[100px] p-2">
            <div class="text-gray-400 text-sm">28</div>
          </div>
          <!-- Повторить аналогичные блоки для остальных дней -->

          <!-- Текущий день -->
          <div class="bg-white min-h-[100px] p-2 ring-2 ring-primary-500 ring-inset">
            <div class="flex justify-between">
              <div class="text-primary-700 font-medium">15</div>
              <div class="text-xs text-gray-500">Сегодня</div>
            </div>
            <!-- Задачи на текущий день -->
            <div class="mt-2 space-y-1">
              <div class="px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-800 truncate">
                Инвентаризация склада А
              </div>
              <div class="px-2 py-1 text-xs rounded-md bg-red-100 text-red-800 truncate">
                Проверка поставки #12345
              </div>
            </div>
          </div>

          <!-- Остальные дни -->
          <div class="bg-white min-h-[100px] p-2">
            <div class="text-gray-700 text-sm">16</div>
            <!-- Задачи на день -->
            <div class="mt-2 space-y-1">
              <div class="px-2 py-1 text-xs rounded-md bg-green-100 text-green-800 truncate">
                Отгрузка заказа #789
              </div>
            </div>
          </div>
          <!-- Повторить аналогичные блоки для остальных дней -->
        </div>
      </div>
    </div>

    <!-- Если задач нет -->
    <div th:if="${#lists.isEmpty(tasks)}" class="text-center py-10 bg-white rounded-lg shadow">
      <div class="flex flex-col items-center">
        <svg class="h-20 w-20 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
          </path>
        </svg>
        <h3 class="mt-2 text-lg font-medium text-gray-900">Задач не найдено</h3>
        <p class="mt-1 text-sm text-gray-500">
          Не найдено задач, соответствующих текущим фильтрам.
        </p>
        <div th:if="${userRole == T(bbt.tao.warehouse.model.enums.RoleType).ADMIN ||
              userRole == T(bbt.tao.warehouse.model.enums.RoleType).MANAGER}" class="mt-6">
          <button @click="showTaskCreationForm = true"
                  class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            <i class="fas fa-plus mr-2"></i> Создать новую задачу
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно с деталями задачи -->
  <div x-show="showTaskDetails" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" x-transition>
    <div @click.away="showTaskDetails = false" class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-lg font-medium" x-text="currentTask.title">Детали задачи</h2>
        <button @click="showTaskDetails = false" class="text-gray-400 hover:text-gray-500">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-6 space-y-6">
        <!-- Основная информация -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-sm font-medium text-gray-500">Статус</h3>
            <div class="mt-1">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                :class="{
                  'bg-gray-100 text-gray-800': currentTask.status === 'PLANNED',
                  'bg-blue-100 text-blue-800': currentTask.status === 'IN_PROGRESS',
                  'bg-green-100 text-green-800': currentTask.status === 'COMPLETED',
                  'bg-red-100 text-red-800': currentTask.status === 'CANCELLED'
                }"
                x-text="currentTask.status">
            PLANNED
          </span>
            </div>
          </div>

          <div>
            <h3 class="text-sm font-medium text-gray-500">Приоритет</h3>
            <div class="mt-1 flex items-center">
          <span class="inline-block h-2 w-2 rounded-full mr-2"
                :class="{
                  'bg-priority-critical': currentTask.priority === 'CRITICAL',
                  'bg-priority-high': currentTask.priority === 'HIGH',
                  'bg-priority-medium': currentTask.priority === 'MEDIUM',
                  'bg-priority-low': currentTask.priority === 'LOW'
                }">
          </span>
              <span x-text="currentTask.priority">MEDIUM</span>
            </div>
          </div>

          <div>
            <h3 class="text-sm font-medium text-gray-500">Срок выполнения</h3>
            <div class="mt-1" x-text="formatDate(currentTask.dueDate)">31.12.2024 18:00</div>
          </div>

          <div>
            <h3 class="text-sm font-medium text-gray-500">Категория</h3>
            <div class="mt-1" x-text="currentTask.category?.name">Инвентаризация</div>
          </div>

          <div>
            <h3 class="text-sm font-medium text-gray-500">Исполнитель</h3>
            <div class="mt-1 flex items-center">
              <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="text-xs font-medium" x-text="getInitials(currentTask.assignee?.fullName)">МР</span>
              </div>
              <div class="ml-2" x-text="currentTask.assignee?.fullName">Михаил Родригес</div>
            </div>
          </div>

          <div>
            <h3 class="text-sm font-medium text-gray-500">Местоположение</h3>
            <div class="mt-1" x-text="currentTask.location?.name">Склад А, Зона 3</div>
          </div>

          <div class="md:col-span-2">
            <h3 class="text-sm font-medium text-gray-500">Описание</h3>
            <div class="mt-1 prose prose-sm max-w-none" x-text="currentTask.description">
              Провести полную инвентаризацию склада А, включая проверку соответствия фактического наличия товаров данным в системе.
            </div>
          </div>
        </div>

        <!-- Прогресс -->
        <div>
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">Прогресс выполнения</h3>
            <span class="text-sm font-medium" x-text="currentTask.progressPercentage + '%'">45%</span>
          </div>
          <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
            <div class="bg-primary-500 h-2 rounded-full" :style="'width: ' + currentTask.progressPercentage + '%'"></div>
          </div>
        </div>

        <!-- Связанные товары -->
        <div x-show="currentTask.relatedItems && currentTask.relatedItems.length > 0">
          <h3 class="text-sm font-medium text-gray-500 mb-2">Связанные товары</h3>
          <div class="bg-gray-50 rounded-md p-3">
            <ul class="space-y-2">
              <template x-for="item in currentTask.relatedItems" :key="item.id">
                <li class="flex justify-between">
                  <span x-text="item.sku + ' - ' + item.name">SKU123 - Товар 1</span>
                  <span x-text="item.quantity + ' шт.'">10 шт.</span>
                </li>
              </template>
            </ul>
          </div>
        </div>

        <!-- История изменений -->
        <div>
          <h3 class="text-sm font-medium text-gray-500 mb-2">История изменений</h3>
          <div class="space-y-4">
            <div class="relative">
              <div class="absolute left-0 top-0 ml-[-5px] mt-[9px] h-full w-0.5 bg-gray-200"></div>
              <div class="relative flex items-start space-x-3">
                <div>
                  <div class="relative px-1 bg-white">
                    <div class="h-2 w-2 rounded-full bg-gray-300"></div>
                  </div>
                </div>
                <div class="min-w-0 flex-1">
                  <div class="text-sm text-gray-500 mb-0.5">
                    <span class="font-medium text-gray-900">Система</span> создала задачу
                  </div>
                  <div class="text-xs text-gray-400">01.11.2024 10:15</div>
                </div>
              </div>
            </div>

            <div class="relative">
              <div class="absolute left-0 top-0 ml-[-5px] mt-[9px] h-full w-0.5 bg-gray-200"></div>
              <div class="relative flex items-start space-x-3">
                <div>
                  <div class="relative px-1 bg-white">
                    <div class="h-2 w-2 rounded-full bg-gray-300"></div>
                  </div>
                </div>
                <div class="min-w-0 flex-1">
                  <div class="text-sm text-gray-500 mb-0.5">
                    <span class="font-medium text-gray-900">Михаил Родригес</span> изменил статус на <span class="font-medium">В процессе</span>
                  </div>
                  <div class="text-xs text-gray-400">01.11.2024 14:30</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 justify-end">
          <button x-show="currentTask.status !== 'COMPLETED' && currentTask.status !== 'CANCELLED'"
                  class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-play mr-2"></i> Начать выполнение
          </button>

          <button x-show="currentTask.status === 'IN_PROGRESS'"
                  class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <i class="fas fa-check mr-2"></i> Завершить задачу
          </button>

          <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-comment mr-2"></i> Добавить комментарий
          </button>

          <button x-show="userRole === 'ADMIN' || userRole === 'MANAGER'"
                  class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-edit mr-2"></i> Редактировать
          </button>

          <button x-show="userRole === 'ADMIN'"
                  class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            <i class="fas fa-trash mr-2"></i> Удалить
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  function taskManager() {
    return {
      showFilters: false,
      showTaskCreationForm: false,
      showTaskDetails: false,
      viewMode: 'list',
      currentTask: {},
      userRole: '[[${userRole}]]',

      openTaskDetails(task) {
        this.currentTask = task;
        this.showTaskDetails = true;
      },

      formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
      },

      getInitials(fullName) {
        if (!fullName) return '';
        return fullName.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
      }
    }
  }
</script>
</body>
</html>